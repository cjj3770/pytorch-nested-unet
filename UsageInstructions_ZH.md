# 开发环境使用说明

## 1 通用开发
环境启动后，如果环境镜像中安装了Jupyterlab或SSH，将会调度资源完成Jupyter环境和SSH通道的创建。

### 1.1  使用JupyterLab
开发环境任务状态为“运行中”后，用户可以启动Jupyterlab窗口，一个开发环境只能启动一个窗口，运行在master节点上（如果申请的是分布式多节点资源），请在Jupyterlab工作窗中进行开发，可以上传文件到开发环境中。

### 1.2  使用SSH
SSH通道在开发环境任务状态为“运行中”后，即可看到SSH访问的信息，如果添加的是分布式多节点，只会提供master节点的访问通道。可以在个人账号管理中添加SSH密钥。

### 1.3  交互式端口
交互式端口是用于给开发环境开放额外端口用于其他访问。

### 1.4  目录说明
开发环境会生成6个可持久化目录（请用户遵守目录使用约定）：
- `code`：项目代码开发目录的本地副本，代码采用git版本工具来管理，项目删除该目录会删掉。第一次启动开发环境时，会自动从外部代码仓库clone到此文件夹
- `outputs`：存放项目用户私有输出文件，项目删除该目录会删掉
- `userdata`：存放用户私有文件，项目删除不会影响userdata目录
- `teamdata`：存放用户组共享文件，项目删除不会影响teamdata目录
- `adhub/{name}/{Vn}`：存放ADHub数据集列表，该目录为只读目录，项目删除不会影响ADHub目录
- `models/{name}/{Vn}`：存放从模型工厂导入的二次开发的模型，项目删除不会影响models目录


## 2  推理开发
对于已训练好的推理模型，若希望开发其前后处理代码，则启动开发环境时，可以选择推理开发，或选择平台预置的推理开发镜像。
推理开发镜像提供了Triton推理框架、前后处理代码样例以及推理调试插件，便于快速编写和调试推理代码。
推理开发环境与通用开发相同，也可使用JupyterLab、SSH和交互式端口。

### 2.1  编写前处理、后处理代码
请参考镜像中的前后处理代码样例（Python/C语言）及说明。

### 2.2  调试前处理、后处理代码
若要调试编好的前后处理代码，可以打开推理调试工具，启动推理服务，在线预测图片和文本，直观地查看预测结果是否正确，以及查看日志信息。


## 3  保存镜像
通用开发代码或推理前后处理代码调试完毕后，可以将整个master节点上的开发环境保存成一个镜像，镜像会保存到镜像中心中的所属空间，以便下次直接使用。如果使用了推理开发环境，则保存的镜像支持Triton推理。


## 4  模型发布
若要将开发好的模型发布到模型工厂APWorkshop，用于后续训练、推理、自动标注等用途，需要：
1. 按照下列说明编写和存放配置文件，否则使用该模型时会出错；
2. 发布前，请先git提交代码；
```
git add .
git commit -m “备注信息”
git push
```
3. 按照平台提供的模型发布命令行进行操作，否则无法正确发布模型。
```/start/aplab  -trainOutPutPath {训练输出路径} -modelName {模型名称}```

### 4.1  配置文件说明
新建开发环境时，code目录中有下列3个配置文件模板，请按照内容正确填写。
1. manifest.yaml：配置模型训练、评估的参数；
2. serve_desc.yaml：配置模型推理的总体参数；
3. serve.yaml：配置推理模型的具体参数，若有n个推理模型，则对应有n个serve.yaml。

### 4.2  配置文件存放目录
请将配置文件存放到指定目录。
1. manifest.yaml：`code`文件夹；
2. serve_desc.yaml：`{训练输出路径}`；
3. serve.yaml：`{训练输出路径}/{模型名称}`，每个推理模型目录下都有一个serve.yaml。

- 目录例子
```
code/
|   manifest.yaml
|
outputs/
|   my_training_outputs/
|   |   my_plugin_1/
|   |   |   serve.yaml
|   |   |
|   |   my_plugin_2/
|   |   |   serve.yaml
|   |   |
|   |   my_plugin_3/
|   |   |   serve.yaml
|   |   |
|   |   serve_desc.yaml
|   |   class_name.txt
```
例子中的训练输出路径为`my_training_outputs`文件夹，您也可以自行指定。

### 4.3  自动标注
推理模型发布后，即可用于数据标注平台 ADMagic 的自动标注。
若希望自动标注时，将模型推理输出标签与 ADMagic 标注标签建立映射，则在模型发布前，需要完成如下事项：
1. 在`{训练输出路径}`下，新建文本文件`class_names.txt`，UTF-8编码；
2. 将模型输出的标签填入`class_names.txt`，每一行为一个标签，换行分隔。
   例如猫狗目标检测模型，输出标签为“dog”、“cat”，那么，`class_names.txt`内容为
   ```
   dog
   cat
   ```